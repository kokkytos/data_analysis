---
title: "Τεχνικές δειγματοληψίας στην R με εφαρμογή σε γεωγραφικά δεδομένα"
author: "Leonidas Liakos"
date: "5/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Στόχος του τρέχοντος notebook είναι να επιδειχθεί η απλή τυχαία δειγματοληψία, η συστηματική δειγματοληψία, η δειγματοληψία κατά συστάδες και η στρωματοποιημένη δειγματοληψία με την R.



# Εισαγωγή των απαραίτητων βιβλιοθηκών

Αρχικά εισάγουμε τις απαραίτητες βιβλιοθήκες για την διεκπεραίωση της διαδικασίας. 

```{r message=FALSE, warning=FALSE}
library(sf) # βιβλιοθήκη για την ανάγνωση διανυσματικών δεδομένων
library(leaflet) # βιβλιοθήκη για την χαρτογραφική απόδοση των δεδομένων σε χάρτη leaflet
library(tidyverse) # εξειδικευμένη βιβλιοθήκη για διαχείριση και επεξεργασία δεδομένων
```



Ανάγνωση του αρχείου οικισμών (geojson).

```{r}
oikismoi <-st_read("./data/oikismoi.geojson") 
```


Προσθήκη στήλης με αύξοντα αριθμό (id) για τον καθορισμό του δειγματοληπτικού πλαισίου.

```{r}
oikismoi <-oikismoi%>% 
  mutate(id=row_number()) 
```

Χαρτογραφική απόδοση των δεδομένων του πληθυσμού σε χάρτη leaflet.

```{r}
leaflet(data = oikismoi ) %>%
  addTiles() %>%
  addMarkers(
    ~ X,
    ~ Y,
    
    popup = ~ as.character(id),
    label = ~ as.character(OIKISMOS),
    clusterOptions = markerClusterOptions()
  )
```
# Aπλή τυχαία δειγματοληψία


Από τον σύνολο των οικισμών την Ελλάδα που υπάρχουν στο αρχείο vector θα επιλεγεί δείγμα από 350 οικισμούς.

Προσαρτούμε σε δύο μεταβλητές το μέγεθος του πληθυσμού Ν και το μέγεθος του δείγματος n.
Το δειγματοληπτικό πλαίσιο ορίζεται από το σύνολο των οικισμών και είναι καταγεγγραμένοι στην στήλη id με αύξουσα αρίθμηση.


```{r}
set.seed(1)
N <- oikismoi %>% nrow() # υπολογίσουμε το σύνολο των στατιστικών μονάδων του πληθυσμού
n=350 # ορίζουμε το επιθυμητό δείγμα
deigma <- sample(N, n)
```


Προσάρτηση του δείγματος των οικισμών σε μία νέα μεταβλητή
```{r}
deigma_oikismon <- oikismoi %>% filter(id %in% deigma)
```



Χαρτογραφική απόδοση των δεδομένων του δείγματος
```{r}
leaflet(data = deigma_oikismon ) %>%
  addTiles() %>%
  addMarkers(
    ~ X,
    ~ Y,
    
    popup = ~ as.character(id),
    label = ~ as.character(OIKISMOS),
    clusterOptions = markerClusterOptions()
  )
```




# Συστηματική δειγματοληψία

Για την συστηματική δειγματοληψία απαιτείται η εύρεση του πηλίκου k=N/n (βήμα). Το πηλίκο αυτό στρογγυλοποιείται προς τον πλησιέστερο ακέραιο (λ). Στην συνέχεια επιλέγουμε έναν τυχαίο αριθμό 1<ρ<λ.

```{r}
set.seed(1)
k <- N/n # k = πηλίκο N/n
l <- round(k, 0) # λ = στρογγυλοποίηση k προς τον πλησιέστερο ακέραιο

r <- sample(1:l, 1) # ρ τυχαίο αριθμό 1<ρ<λ
systematic_sample <- seq(r, r + l*(n-1), l) # επιλογή δείγματο με συστηματική δειγματοληψία
```

Παίρνουμε το δείγμα των οικισμών σε μία νέα μεταβλητή.
```{r}
deigma_oikismon_systematic <- oikismoi %>% filter(id %in% systematic_sample)
```

Οπτικοποίηση του δείγματος των οικισμών από την συστηματική δειγματοληψία
```{r}
leaflet(data = deigma_oikismon_systematic ) %>%
  addTiles() %>%
  addMarkers(~X,
                   ~Y,

                   popup = ~as.character(id),
                   label = ~as.character(OIKISMOS))

```



# Στρωματοποιημένη δειγματοληψία

## Στρωματοποιημένη δειγματοληψία με μη αναλογικό δείγμα

Ορίζουμε τα επιμέρους στρώματα οικισμών ανάλογα το υψόμετρο σε:

  Πεδινός: 0-100
  
  Ημιορεινός: 100-700
  
  Ορεινός: >700

```{r}
oikismoi$category <- cut(oikismoi$height, 
                   breaks=c(0, 100, 700, Inf), 
                   labels=c("Πεδινός","Ημιορεινός","Ορεινός"),include.lowest = TRUE,)
```

Για κάθε στρώμα επιλέγουμε δείγμα 100 οικισμών.

```{r}
set.seed(1)
strat_sample <- oikismoi %>%
                  group_by(category) %>%
                  sample_n(size=100)

```

Επιβεβαιώνουμε ότι ανά στρώμα έχουμε δείγμα από 100 οικισμούς.

```{r}

table(strat_sample$category)
```
Το συνολικό δείγμα που προέκυψε είναι 300 οικισμοί και είναι μη αναλογικό (ίδιος αριθμός στατιστικών μονάδων δείγματος ανά υψομετρική κατηγορία ανεξάρτητα από την κατανομή του κάθε στρώματος επί του πληθυσμού).


## Στρωματοποιημένη δειγματοληψία με αναλογικό δείγμα

Μπορούμε να εκτελέσουμε αναλογική δειγματοληψία ορίζοντας ένα ποσοστό οικισμών π.χ. 15% για κάθε στρώμα.

```{r}
set.seed(1)
strat_sample_prop <- oikismoi %>%
                  group_by(category) %>%
                  sample_frac(0.15)

```


Πλέον τα επιμέρους στρώματα έχουν διαφορετικό μέγεθος δείγματος
```{r}
table(strat_sample_prop$category)
```


# Δειγματοληψία κατά συστάδες

Οι ομάδες μέσω των οποίων θα επιλεχθεί το δείγμα των οικισμών είναι οι Καλλικρατικοί Δήμοι.
Θα επιλέξουμε από τους δήμους με απλή τυχαία δειγματοληψία 5 από αυτούς.

```{r}
set.seed(1)
clusters <- sample(unique(oikismoi$DHMOS), size=5, replace=F) # επιλογή 5 τυχαίων δήμων
```

```{r}

cluster_sample <- oikismoi %>% filter(DHMOS %in% clusters) # επιλογή δείγματος οικισμών με βάση τις ομάδες (δήμους)
```


Τα δείγματα που προκύπτουν ανά ομάδα (Δήμο) επιμερίζονται ως εξής:

```{r}
table(cluster_sample$DHMOS)
```

_Υποσημείωση:_ για να εξασφαλίσουμε την αναπαραγωγιμότητα του τρέχοντος αρχείου κατά την κλήση των συναρτήσεων δειγματοληψίας προηγείται η εκτέλεση της συνάρτησης set.seed(1)
